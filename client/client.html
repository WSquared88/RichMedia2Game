<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
	<!-- <link rel='stylesheet', href='assets/style.css' > -->
	<style>
	
	*{
		color: black;
		font-size: 12px;
		background-color: #CAD7DB;
	}

	#title
	{
		padding: 1em;
		color: #27AAD6;
		background-color: #E8D9DF;
		text-align: center;
		border: solid;
		font-size: 50px;
	}

	body
	{
		background-color: lightgrey;
		margin: auto;
		overflow: hidden;
	}

	canvas
	{
		width: 100%;
		background-color: white;
		font-family: "Arial";
		font-size: 2em;
	}
	</style>
    <script>
        "use strict";
    
        var canvas;
        var ctx;
        var socket;
		var cardsInHand = [];
		var numCardsInOpponentsHand = 0;
		var points = 0;
		var animationID;
		var wIsPressed = false;
		var aIsPressed = false;
		var sIsPressed = false;
		var dIsPressed = false;
		var myTurn = false;
		var opponent = {};
		var board = [];
		var mouse = 
		{
			x: -1,
			y: -1
		};
		
		var bk = new Image();
		var bkLoaded = false;

        var player = {
            id: 0,
			time: new Date().getTime(),
			color: "rgba("+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", 1)",
			points: 0
        };
		
		function draw()
		{
			ctx.fillStyle = "rgba(100, 150, 200, 1)";
			ctx.clearRect(0,0,canvas.width, canvas.height);
			
			if (bkLoaded)
			{
				ctx.drawImage(bk,0,0, canvas.width, canvas.height);
			}
			
			
			ctx.strokeStyle = "black";
			ctx.fillStyle = "CornFlowerBlue";
			ctx.lineWidth = 5;
			
			//top
			ctx.strokeRect(0,0,canvas.width-3,canvas.height/8);
			ctx.fillRect(0,0,canvas.width-3,canvas.height/8);
			
			var tempY = canvas.height *3/5;//ctx.canvas.height - (40*2) + 40/4;
			//bottom
			ctx.strokeRect(0,tempY,canvas.width-3,canvas.height/5);
			ctx.fillRect(0,tempY,canvas.width-3,canvas.height/5);
			
			
			
			//console.log("Starting card draw");
			
			for(var i = 0;i<cardsInHand.length;i++)
			{
				ctx.fillStyle = "black";
				ctx.fillRect(cardsInHand[i].posX-2, cardsInHand[i].posY-2, cardsInHand[i].width+4, cardsInHand[i].height+4);
				ctx.fillStyle = "#93CCEA";
				
				if(cardsInHand[i].hovering)
				{
					ctx.fillStyle = "#008000";
				}
				
				ctx.fillRect(cardsInHand[i].posX, cardsInHand[i].posY, cardsInHand[i].width, cardsInHand[i].height);
				ctx.textAlign = "center";
				ctx.fillStyle = "black";
				ctx.fillText(cardsInHand[i].name, cardsInHand[i].posX+cardsInHand[i].width/2, cardsInHand[i].posY+30);
				//console.log("Drawing card " + cardsInHand[i].name + " at " + cardsInHand[i].posX + " " + cardsInHand[i].posY);
			}
			
			ctx.fillStyle = "black";
			ctx.textAlign = "center";
			ctx.font = "20px Arial";
			if(Object.keys(opponent).length === 0 && JSON.stringify(opponent) === JSON.stringify({}))
			{
				ctx.fillText("Waiting for an Opponent to connect", ctx.canvas.width/2, ctx.canvas.height/3);
			}
			else if(myTurn)
			{
				ctx.strokeStyle = "black";
				ctx.fillStyle = "#93CCEA";
				ctx.lineWidth = 5;
				ctx.strokeRect(canvas.width/2 - 120,ctx.canvas.height/10 - 30,240,50);
				ctx.fillRect(canvas.width/2 - 120,ctx.canvas.height/10 - 30,240,50);
				
				ctx.fillStyle = "black";
				ctx.fillText("Your Turn", ctx.canvas.width/2, ctx.canvas.height/10 - 10);
				ctx.fillText("Press W to pass the turn", ctx.canvas.width/2, ctx.canvas.height/10 + 15);
			}
			else if(!myTurn)
			{
				ctx.strokeStyle = "black";
				ctx.fillStyle = "#93CCEA";
				ctx.lineWidth = 5;
				ctx.strokeRect(canvas.width/2 - 120,ctx.canvas.height/10 - 30,240,50);
				ctx.fillRect(canvas.width/2 - 120,ctx.canvas.height/10 - 30,240,50);
				
				ctx.fillStyle = "black";
				ctx.fillText("Opponent's Turn", ctx.canvas.width/2, ctx.canvas.height/10);
				//ctx.fillText("Opponent's Turn", ctx.canvas.width/2, ctx.canvas.height/3);
			}
			
			ctx.textAlign = "left";
			ctx.fillText("Cards: "+Object.keys(cardsInHand).length, 10, 30);
			ctx.fillText("Opponents Cards: "+numCardsInOpponentsHand, 10, 60);
			ctx.fillText("Left click to use a card!", 10, 90);
		}
		
		function update()
		{
			animationID = requestAnimationFrame(update);
			
			for(var i = 0;i<cardsInHand.length;i++)
			{
				cardsInHand[i].hovering = false;
			}
			
			if(wIsPressed)
			{
				//square.y -= 3;
				console.log("player id " + player.id);
				socket.emit("nextTurn", player);
			}
			
			if(aIsPressed)
			{
				//square.x -= 3;
			}
			
			if(sIsPressed)
			{
				//square.y += 3;
			}
			
			if(dIsPressed)
			{
				//square.x += 3;
			}
			
			sendPos();
			/*if(wIsPressed || aIsPressed || sIsPressed || dIsPressed)
			{
				sendPos();
			}*/
			var index = checkCardHover();
			
			if(index != -1)
			{
				cardsInHand[index].hovering = true;
			}
			
			draw();
		}
		
		function checkCardHover()
		{
			var foundCard = false;
				
			for(var i = cardsInHand.length-1;i>=0;i--)
			{
				var card = cardsInHand[i];
				
				if(mouse.x > card.posX && mouse.y > card.posY && mouse.x < card.posX + card.width && mouse.y < card.posY + card.height)
				{
					return i;
				}
			}
			return -1;
		}
		
		function sendPos()
		{
			var message = 
			{
				message: "",
				id: player.id,
				data: player,
				time: new Date().getTime()
			};
			
			socket.emit("updatePos", message);
		}
        
        function init() 
		{
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
			
			canvas.addEventListener("mousemove", function(e)
			{
				var rect = canvas.getBoundingClientRect();
				mouse = 
				{
					x: e.clientX - rect.left,
					y: e.clientY - rect.top
				};
				
				console.log("Moving the mouse");
			}, false);
			
			ctx.canvas.width = window.innerWidth;
			ctx.canvas.height = window.innerHeight;
			
			ctx.font = "20px Arial";
			
			loadAssets();
			
			socket = io.connect();
			socket.on("connect", function()
			{
				var message = 
				{
					message: "",
					data: player
				};
				
				socket.emit("init", message);
			});
			
			socket.on("connected", function(message)
			{
				console.dir("Connected to server ");
				player.id = message.id;
				console.dir(message);
			});
			
			socket.on("startTurn", function()
			{
				console.log("Your turn has started");
				myTurn = true;
			});
			
			socket.on("endTurn", function()
			{
				console.log("Your turn has ended");
				myTurn = false;
			});
			
			socket.on("updateCards", function(data)
			{
				cardsInHand = data.player;
				numCardsInOpponentsHand = data.opp;
				console.log("Updating what the cards look like"+cardsInHand.length);
				for(var i = 0;i<cardsInHand.length;i++)
				{
					cardsInHand[i].posX = (((ctx.canvas.width-cardsInHand[0].width)/cardsInHand.length)*i) + (((ctx.canvas.width-cardsInHand[0].width)/cardsInHand.length)/2);
					cardsInHand[i].posY = ctx.canvas.height - (cardsInHand[i].height*2) + cardsInHand[i].height/4;
					console.log("Card Name: "+cardsInHand[i].name);
				}
			});
			
			socket.on("playerConnected", function(opp)
			{
				console.log("An opponent connected to your room");
				console.log("Player Stats:");
				console.log("Num cards in hand: " + opp.numCards);
				console.log("Num cards in deck: " + opp.numDeck);
				console.log("Graveyard: " + opp.grave);
				opponent = opp;
			});
			
			socket.on("playerDisconnected", function()
			{
				console.log("Your opponent has disconnected");
				opponent = {};
			});
			
			socket.on("exception", function(message)
			{
				console.log(message.data);
			});
			
			socket.on("log", function(message)
			{
				console.log(message.data);
			});
			
			document.onkeydown = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = true;
				}
				
				if(charCode == "A")
				{
					aIsPressed = true;
				}
				
				if(charCode == "S")
				{
					sIsPressed = true;
				}
				
				if(charCode == "D")
				{
					dIsPressed = true;
				}
			};
			
			document.onkeyup = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = false;
				}
				
				if(charCode == "A")
				{
					aIsPressed = false;
				}
				
				if(charCode == "S")
				{
					sIsPressed = false;
				}
				
				if(charCode == "D")
				{
					dIsPressed = false;
				}
			};
			
			document.onmousedown = function(e)
			{
				console.log(e.clientX);//if(
				console.log(e.clientY);
				
				
				
				for(var i = 0;i<board.length;i++)
				{
					for(var j = 0;j<board[i].length;j++)
					{
						
					}
				}
				
				var message = 
				{
					card: cardsInHand[0],
				}
				socket.emit("useCard", message);
			}
			
			requestAnimationFrame(update);
        }//end init

		function loadAssets(){
		
			bk.onload = function(){
				//ctx.drawImage(bk,0,0);
				bkLoaded = true;
				console.log("BK loaded");
			};
			//bk.src = "bk.png";
			//bk.src = "assets/bk.png";
			//bk.src ="client/bk.png";
			bk.src = "https://people.rit.edu/pmm9335/images/bk.png";
		}
    window.onload = init;
	window.onresize = function()
	{
		ctx.canvas.width = window.innerWidth;
		ctx.canvas.height = window.innerHeight;
		console.log(window.innerHeight);
		draw();
	};
    </script>
</head>
<body>
	<h1 id = "title" >Springs of Albion</h1>
    <canvas id="canvas">Please use an HTML 5 browser</canvas>
</body>
</html>