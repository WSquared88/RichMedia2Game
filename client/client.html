<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
	<!-- <link rel='stylesheet', href='assets/style.css' > -->
	<style>
	
	*{
		color: black;
		font-size: 12px;
		background-color: #CAD7DB;
	}

	#title
	{
		padding: 1em;
		color: #27AAD6;
		background-color: #E8D9DF;
		text-align: center;
		border: solid;
		font-size: 50px;
	}

	body
	{
		background-color: lightgrey;
		margin: auto;
		overflow: hidden;
	}

	canvas
	{
		width: 100%;
		background-color: white;
		font-family: "Arial";
		font-size: 2em;
	}
	</style>
    <script>
        "use strict";
    
        var canvas;
        var ctx;
        var socket;
		var cardsInHand = [];
		var numCardsInOpponentsHand = 0;
		var points = 0;
		var animationID;
		var wIsPressed = false;
		var aIsPressed = false;
		var sIsPressed = false;
		var dIsPressed = false;
		var myTurn = false;
		var opponent = {};
		
		var bk = new Image();
		var bkLoaded = false;

        var player = {
            id: 0,
			time: new Date().getTime(),
			color: "rgba("+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", 1)",
			points: 0
        };
		
		function draw()
		{
			ctx.fillStyle = "rgba(100, 150, 200, 1)";
			ctx.clearRect(0,0,canvas.width, canvas.height);
			
			if (bkLoaded)
			{
				ctx.drawImage(bk,0,0);
			}
			//ctx.beginPath();
			//ctx.arc(200, 200, 100, 0, 2*Math.PI);
			//ctx.fill();
			//ctx.closePath();
			console.log("Starting card draw");
			
			for(var i = 0;i<cardsInHand.length;i++)
			{
				ctx.fillStyle = "black";
				ctx.fillRect(cardsInHand[i].posX-2, cardsInHand[i].posY-2, cardsInHand[i].width+4, cardsInHand[i].height+4);
				ctx.fillStyle = "CornFlowerBlue";
				ctx.fillRect(cardsInHand[i].posX, cardsInHand[i].posY, cardsInHand[i].width, cardsInHand[i].height);
				ctx.textAlign = "center";
				ctx.fillStyle = "black";
				ctx.fillText(cardsInHand[i].name, cardsInHand[i].posX+cardsInHand[i].width/2, cardsInHand[i].posY+30);
				console.log("Drawing card " + cardsInHand[i].name + " at " + cardsInHand[i].posX + " " + cardsInHand[i].posY);
			}
			
			ctx.fillStyle = "black";
			ctx.textAlign = "center";
			ctx.font = "20px Arial";
			if(Object.keys(opponent).length === 0 && JSON.stringify(opponent) === JSON.stringify({}))
			{
				ctx.fillText("Waiting for an Opponent to connect", ctx.canvas.width/2, ctx.canvas.height/3);
			}
			else if(myTurn)
			{
				ctx.fillText("Your Turn", ctx.canvas.width/2, ctx.canvas.height/3-15);
				ctx.fillText("Press W to pass the turn", ctx.canvas.width/2, ctx.canvas.height/3+15);
			}
			else if(!myTurn)
			{
				ctx.fillText("Opponent's Turn", ctx.canvas.width/2, ctx.canvas.height/3);
			}
			
			ctx.textAlign = "left";
			ctx.fillText("Cards: "+Object.keys(cardsInHand).length, 10, 30);
			ctx.fillText("Opponents Cards: "+numCardsInOpponentsHand, 10, 60);
		}
		
		function update()
		{
			animationID = requestAnimationFrame(update);
			if(wIsPressed)
			{
				//square.y -= 3;
				console.log("player id " + player.id);
				socket.emit("nextTurn", player);
			}
			
			if(aIsPressed)
			{
				//square.x -= 3;
			}
			
			if(sIsPressed)
			{
				//square.y += 3;
			}
			
			if(dIsPressed)
			{
				//square.x += 3;
			}
			
			sendPos();
			/*if(wIsPressed || aIsPressed || sIsPressed || dIsPressed)
			{
				sendPos();
			}*/
			draw();
		}
		
		function sendPos()
		{
			var message = 
			{
				message: "",
				id: player.id,
				data: player,
				time: new Date().getTime()
			};
			
			socket.emit("updatePos", message);
		}
        
        function init() 
		{
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
			
			ctx.canvas.width = window.innerWidth;
			ctx.canvas.height = window.innerHeight;
			
			ctx.font = "20px Arial";
			
			loadAssets();
			
			socket = io.connect();
			socket.on("connect", function()
			{
				var message = 
				{
					message: "",
					data: player
				};
				
				socket.emit("init", message);
			});
			
			socket.on("connected", function(message)
			{
				console.dir("Connected to server ");
				player.id = message.id;
				console.dir(message);
			});
			
			socket.on("startTurn", function()
			{
				console.log("Your turn has started");
				myTurn = true;
			});
			
			socket.on("endTurn", function()
			{
				console.log("Your turn has ended");
				myTurn = false;
			});
			
			socket.on("updateCards", function(data)
			{
				cardsInHand = data.player;
				numCardsInOpponentsHand = data.opp;
				console.log("Updating what the cards look like"+cardsInHand.length);
				for(var i = 0;i<cardsInHand.length;i++)
				{
					cardsInHand[i].posX = ((((ctx.canvas.width-cardsInHand[0].width*1.5)/cardsInHand.length) )*i)+cardsInHand[0].width/2;//(i*(cardsInHand[i].width+50)) + ((i+1)*5);
					cardsInHand[i].posY = ctx.canvas.height - (cardsInHand[i].height) - 50;
					console.log("Card Name: "+cardsInHand[i].name);
				}
			});
			
			socket.on("playerConnected", function(opp)
			{
				console.log("An opponent connected to your room");
				console.log("Player Stats:");
				console.log("Num cards in hand: " + opp.numCards);
				console.log("Num cards in deck: " + opp.numDeck);
				console.log("Graveyard: " + opp.grave);
				opponent = opp;
			});
			
			socket.on("playerDisconnected", function()
			{
				console.log("Your opponent has disconnected");
				opponent = {};
			});
			
			socket.on("exception", function(message)
			{
				console.log(message.data);
			});
			
			socket.on("log", function(message)
			{
				console.log(message.data);
			});
			
			document.onkeydown = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = true;
				}
				
				if(charCode == "A")
				{
					aIsPressed = true;
				}
				
				if(charCode == "S")
				{
					sIsPressed = true;
				}
				
				if(charCode == "D")
				{
					dIsPressed = true;
				}
			};
			
			document.onkeyup = function(e)
			{
				var charCode = String.fromCharCode(e.keyCode);
				if(charCode == "W")
				{
					wIsPressed = false;
				}
				
				if(charCode == "A")
				{
					aIsPressed = false;
				}
				
				if(charCode == "S")
				{
					sIsPressed = false;
				}
				
				if(charCode == "D")
				{
					dIsPressed = false;
				}
			};
			
			document.onmousedown = function(e)
			{
				console.log(e.clientX);//if(
				console.log(e.clientY);
			}
			
			requestAnimationFrame(update);
        }//end init

		function loadAssets(){
		
			bk.onload = function(){
				ctx.drawImage(bk,0,0);
				bkLoaded = true;
				console.log("BK loaded");
			};
			//bk.src = "bk.png";
			//bk.src = "assets/bk.png";
			//bk.src ="client/bk.png";
			bk.src = "https://www.gstatic.com/images/branding/googlelogo/2x/googlelogo_color_284x96dp.png";
		}
    window.onload = init;
	window.onresize = function()
	{
		ctx.canvas.width = window.innerWidth;
		ctx.canvas.height = window.innerHeight;
		console.log(window.innerHeight);
		draw();
	};
    </script>
</head>
<body>
	<h1 id = "title" >Springs of Albion</h1>
    <canvas id="canvas">Please use an HTML 5 browser</canvas>
</body>
</html>